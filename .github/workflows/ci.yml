name: "CI - Code Quality and Tests"

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - dev

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run CI manually'
        required: false
        default: "dev"

jobs:
  build-and-test:
    name: Build and test
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read

    env:
      SOLUTION_NAME: src/Currency.Reference.Iso4217.Solution.sln
      PACKAGE_PROJECT_PATH: src/packages/Currency.Reference.Iso4217/Currency.Reference.Iso4217.csproj
      PACKAGE_NUSPEC_FILE_PATH: Currency.Reference.Iso4217.nuspec
      OUTPUT_NUGET_DIR: nuget-packages

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_NAME }}
        
    - name: Perform build
      run: dotnet build ${{ env.SOLUTION_NAME }} --no-restore --configuration Release

    - name: Run Unit Tests
      run: dotnet test ${{ env.SOLUTION_NAME }} --configuration Release --no-build --verbosity normal
        
    - name: Check Code Formatting
      run: dotnet format ${{ env.SOLUTION_NAME }} --no-restore --verify-no-changes --verbosity detailed

    - name: Extract Project Version
      id: get_version
      run: |
        VERSION=$(grep -oP '(?<=<Version>).*(?=</Version>)' ${{ env.PACKAGE_PROJECT_PATH }} || true | head -1)
        if [ -z "$VERSION" ]; then
          VERSION=$(grep -oP '(?<=<VersionPrefix>).*(?=</VersionPrefix>)' ${{ env.PACKAGE_PROJECT_PATH }} || true | head -1)
        fi
        if [ -z "$VERSION" ]; then
          VERSION=$(grep -oP '(?<=<PackageVersion>).*(?=</PackageVersion>)' ${{ env.PACKAGE_PROJECT_PATH }} || true | head -1)
        fi
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d)
        fi
        echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV
      shell: bash

    - name: Validate Package Creation
      run: dotnet pack ${{ env.PACKAGE_PROJECT_PATH }} /p:NuspecFile=${{ env.PACKAGE_NUSPEC_FILE_PATH }} --configuration Release --no-build --output ${{ env.OUTPUT_NUGET_DIR }}

    - name: Upload Package artifact (Optional)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NUGET_DIR }}-${{ env.CURRENT_VERSION }} 
        path: ${{ env.OUTPUT_NUGET_DIR }}/*.nupkg

    - name: Generate Changelog tool setup
      uses: orf/install-git-cliff@v1
    
    - name: Create CHANGELOG.md
      run: git-cliff --tag ${{ env.CURRENT_VERSION }} > CHANGELOG.md
      
    - name: Upload Changelog artifact (Optional)
      uses: actions/upload-artifact@v4
      with:
        name: changelog-${{ env.CURRENT_VERSION }}
        path: CHANGELOG.md